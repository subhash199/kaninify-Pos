@page "/enquiry"
@using DataHandlerLibrary.Interfaces
@using DataHandlerLibrary.Services
@using EposRetail.Components.Pages.Shared
@using EposRetail.Models
@using EposRetail.Services
@inject ProductServices _productServices
@inject NavigationManager _navigationManager
@inject PrinterManagementService _printerManagementService
@inject GlobalErrorLogService GlobalErrorLogService
@inject CheckoutService CheckoutService
@inject UserSessionService UserSession
@inject GeneralServices generalServices
@inject CheckoutStateService CheckoutStateService

<PageTitle>Enquiry</PageTitle>

@if (!showItemSaleHistory)
{
    <div class="d-flex flex-column vh-100 mt-1 disable-scroll enquiry-root">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-12 col-xl-10 mb-3">
                    <div class="card enquiry-card shadow-sm border-0">
                        <div class="card-body p-3 p-md-4">
                            <div class="text-center mb-3">
                                <div class="fs-4 fw-semibold">Product Enquiry</div>
                                <div class="text-muted">@((searchProducts?.Count ?? 0)) results</div>
                            </div>
                            <div class="d-flex justify-content-center align-items-center mb-3">
                                <input type="text" @ref="searchBox" @bind-value="_state.SearchText"
                                       @bind-value:event="oninput" @onkeydown="SearchKeyDownAsync"
                                       class="form-control form-control-lg search-input" placeholder="Search by barcode or name" />
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle enquiry-table" style="table-layout:fixed; width:100%">
                                    <colgroup>
                                        <col style="width:14%" />
                                        <col style="width:20%" />
                                        <col style="width:10%" />
                                        <col style="width:14%" />
                                        <col style="width:9%" />
                                        <col style="width:9%" />
                                        <col style="width:14%" />
                                        <col style="width:5%" />
                                        <col style="width:5%" />
                                    </colgroup>
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-truncate">Barcode</th>
                                            <th class="text-truncate">Name</th>
                                            <th class="text-truncate">Unit Price</th>
                                            <th class="text-truncate">Expiry</th>
                                            <th class="text-truncate">Shelf Qty</th>
                                            <th class="text-truncate">Stockroom Qty</th>
                                            <th class="text-truncate">Department</th>
                                            <th class="text-truncate">Vat</th>
                                            <th class="text-truncate">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (searchProducts?.Count > 0)
                                        {
                                            foreach (var product in searchProducts)
                                            {
                                                <tr @onclick="@(() => OnProductSelectClick(product))" @ondblclick=@(() => HandleRowDoubleClick(product))
                                                    class="@(selectedProduct == product ? "selected" : "")">
                                                    <td class="text-truncate">@product.Product_Barcode</td>
                                                    <td class="text-truncate">@product.Product_Name</td>
                                                    <td class="text-truncate">@product.Product_Selling_Price</td>
                                                    <td class="text-truncate">@product.Expiry_Date.ToShortDateString()</td>
                                                    <td class="text-truncate">@product.ShelfQuantity</td>
                                                    <td class="text-truncate">@product.StockroomQuantity</td>
                                                    <td class="text-truncate">@product.Department?.Department_Name</td>
                                                    <td class="text-truncate">@product.VAT?.VAT_Value</td>
                                                    <td class="text-truncate text-center">
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-primary"
                                                                @onclick="async () => await AddProductToSalesBasketAsync(product)"
                                                                @onclick:stopPropagation="true">
                                                            <i class="bi bi-basket"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="9" class="text-center py-4 text-muted">No products found</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bottom-bar d-flex gap-2 justify-content-center align-items-baseline w-100">
                <button class="col-md-3 btn action-btn btn-back d-flex flex-column align-items-center flex-fill"
                        @onclick="HandleBackClick">
                    <img src="images/icons/svg/arrow_circle_left_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" class="img-fluid mb-2" />
                    <span class="fw-bold">Back</span>
                </button>
                <button class="col-md-3 btn action-btn btn-edit d-flex flex-column align-items-center flex-fill"
                        @onclick="HandleEditClick">
                    <img src="images/icons/svg/assignment_add_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" class="img-fluid mb-2" />
                    <span class="fw-bold">Edit</span>
                </button>
                <button class="col-md-3 btn action-btn btn-history d-flex flex-column align-items-center flex-fill"
                        @onclick="HandleSaleItemHistory">
                    <img src="images/icons/svg/history_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" class="img-fluid mb-2" />
                    <span class="fw-bold">Sale History</span>
                </button>
                <button class="col-md-3 btn action-btn btn-print d-flex flex-column align-items-center flex-fill"
                        @onclick=HandlePrintLabelClick>
                    <img src="images/icons/svg/print_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" class="img-fluid mb-2" />
                    <span class="fw-bold">Print Label</span>
                </button>
            </div>
        </div>
    </div>
    <ModalContainer State="_state"
                    OnModalOk="onmodalokasync"
                    OnModalClose="onmodalcloseasync"
                    OnProductSave="onmodalproductupsertedasync" />

    <GenericMessageModal IsVisible="showAddToBasketSuccessModal"
                         Title="Added to Basket"
                         Message="@addToBasketSuccessMessage"
                         PrimaryButtonText="Ok"
                         SecondaryButtonText="Go to Checkout"
                         PrimaryAction="CloseAddToBasketSuccessModalAsync"
                         SecondaryAction="GoToCheckoutFromAddModalAsync"
                         OnClose="CloseAddToBasketSuccessModalAsync" />
}



@code {
    [Parameter] public CheckoutState _state { get; set; } = new();
    [Parameter] public string BackButtonNavigationLink { get; set; } = "/checkout"; // Default navigation link for the back button

    ElementReference searchBox;

    List<Product> searchProducts = new();
    Product selectedProduct;
    bool showItemSaleHistory = false;

    IPrinterService _printerServices;
    private bool showAddToBasketSuccessModal = false;
    private string addToBasketSuccessMessage = string.Empty;

    protected override void OnInitialized()
    {
        _state = CheckoutStateService.State;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (_printerServices == null)
            {
                _printerServices = await _printerManagementService.GetPrinterServicesAsync();
            }
            await SetFocusOnSearchBoxAsync();
        }
    }

    private async Task SearchKeyDownAsync(KeyboardEventArgs e)
    {
        if (e.Key != "Enter")
        {
            await searchBox.FocusAsync();
            return;
        }

        try
        {
            await ProcessSearchInputAsync();
        }
        catch (Exception ex)
        {
            await GlobalErrorLogService.LogErrorAsync(ex, nameof(SearchKeyDownAsync), "Processing search input on Enter key press");
            await ShowErrorModalAsync("Search Error", ex.Message);
        }
    }

    private async Task SetFocusOnSearchBoxAsync()
    {
        _state.SearchText = "";
        await searchBox.FocusAsync();
    }

    private async Task ProcessSearchInputAsync()
    {
        if (string.IsNullOrEmpty(_state.SearchText))
        {
            await SetFocusOnSearchBoxAsync();
            return;
        }

        var products = await _productServices.GetByConditionAsync(p => p.Product_Barcode.ToLower().Contains(_state.SearchText.ToLower()) 
        || p.Product_Name.ToLower().Contains(_state.SearchText.ToLower()), true);

        if (products != null)
        {
            foreach (var product in products)
            {
                if (!searchProducts.Any(p => p.Id == product.Id))
                {
                    searchProducts.Add(product);
                }
            }
        }
        await SetFocusOnSearchBoxAsync();
        StateHasChanged();
    }
  

    private async Task ShowErrorModalAsync(string title, string message)
    {
        _state.ModalSettings = new ModalSettings
        {
            ModalTitle = title,
            ModalMessage = message,
            ShowModal = true,
            ModalEnum = ModalEnum.Error
        };
        StateHasChanged();
    }


    private async Task HandleRowDoubleClick(Product product)
    {
        if (product == null) return;

        _state.ModalProduct = product;
        _state.ModalSettings = new ModalSettings
        {
            ShowModal = true,
            ModalEnum = ModalEnum.GenericProduct,
            ModalTitle = "Product Details"
        };

    }

    private async Task AddProductToSalesBasketAsync(Product product)
    {
        try
        {
            if (product == null) return;

            await EnsureBasketInitializedAsync();

            var basket = _state.SalesBaskets[_state.HoldBasketIndex];
            await CheckoutService.AddProductToBasketAsync(basket, product, SalesItemTransactionType.Sale, null);

            UpdateCashSuggestions(basket.Transaction.SaleTransaction_Total_Amount);
            _state.SelectedItemIndex = basket.SalesItemsList.Count - 1;
            addToBasketSuccessMessage = $"{product.Product_Name} added to basket.";
            showAddToBasketSuccessModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await GlobalErrorLogService.LogErrorAsync(ex, nameof(AddProductToSalesBasketAsync), "Adding product to sales basket from enquiry");
            await ShowErrorModalAsync("Basket Error", $"Failed to add item to basket: {ex.Message}");
        }
    }

    private async Task GoToCheckoutFromAddModalAsync()
    {
        showAddToBasketSuccessModal = false;
        StateHasChanged();
        _navigationManager.NavigateTo("/checkout", false);
        await Task.CompletedTask;
    }

    private async Task CloseAddToBasketSuccessModalAsync()
    {
        showAddToBasketSuccessModal = false;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task EnsureBasketInitializedAsync()
    {
        _state.SalesBaskets ??= new List<SalesBasket>();

        if (_state.HoldBasketIndex < 0)
        {
            _state.HoldBasketIndex = 0;
        }

        if (_state.SalesBaskets.Count == 0)
        {
            _state.SalesBaskets.Add(new SalesBasket
            {
                Transaction = null,
                SalesItemsList = new List<SalesItemTransaction>()
            });
            _state.HoldBasketIndex = 0;
        }

        if (_state.HoldBasketIndex >= _state.SalesBaskets.Count)
        {
            _state.HoldBasketIndex = 0;
        }

        var basket = _state.SalesBaskets[_state.HoldBasketIndex];
        basket.SalesItemsList ??= new List<SalesItemTransaction>();

        if (basket.Transaction == null)
        {
            basket.Transaction = new SalesTransaction
            {
                SaleTransaction_Total_Amount = 0,
                SaleTransaction_Cash = 0,
                SaleTransaction_Card = 0,
                SaleTransaction_Change = 0,
                Date_Created = DateTime.UtcNow,
                Sale_Start_Date = DateTime.UtcNow
            };

            await UserSession.EnsureCompleteSessionAsync();
            basket.Transaction.DayLog_Id = await UserSession.GetValidDayLogIdAsync();
            basket.Transaction.Created_By_Id = await UserSession.GetValidUserIdAsync();
            basket.Transaction.Last_Modified_By_Id = await UserSession.GetValidUserIdAsync();
        }
    }

    private void UpdateCashSuggestions(decimal totalAmount)
    {
        _state.RoundupCashSuggestion = (int)Math.Ceiling(totalAmount);
        _state.SecondRoundupCashSuggestion = generalServices.RoundUpToNearestFive((int)Math.Ceiling(totalAmount));
    }

    private async Task OnProductSelectClick(Product product)
    {
        if (product != null)
        {
            selectedProduct = product;
            StateHasChanged();
        }
    }

    private async Task onmodalokasync()
    {
        if (_state.ModalSettings.ModalEnum == ModalEnum.Confirmation)
        {
            // User confirmed to print all labels
            await PrintAllLabelsAsync();
        }
        await HideModal();
        await SetFocusOnSearchBoxAsync();

    }
    private async Task onmodalcloseasync()
    {
        await HideModal();
        await SetFocusOnSearchBoxAsync();

    }
    private async Task onmodalproductupsertedasync(Product args)
    {
        if (args == null) return;
        searchProducts.Remove(_state.ModalProduct);
        searchProducts.Add(args);
        await HideModal();
        await SetFocusOnSearchBoxAsync();

    }

    private async Task HideModal()
    {
        _state.ModalSettings.ShowModal = false;
        StateHasChanged();
        await SetFocusOnSearchBoxAsync();
    }

    private async Task HandleEditClick()
    {
        if (selectedProduct == null)
        {
            await ShowErrorModalAsync("No Product Selected", "Please select or double click a product to edit.");
            return;
        }
        _state.ModalProduct = selectedProduct;
        _state.ModalSettings = new ModalSettings
        {
            ShowModal = true,
            ModalEnum = ModalEnum.GenericProduct,
            ModalTitle = "Edit Product"
        };
    }
    private void HandleSaleItemHistory(MouseEventArgs args)
    {
        if (searchProducts?.Count > 0)
        {
            if (selectedProduct == null)
            {
                selectedProduct = searchProducts.FirstOrDefault();
            }
            _state.SearchText = selectedProduct.Product_Barcode;
            _navigationManager.NavigateTo($"/itemsalehistory?barcode={selectedProduct.Product_Barcode}&backurl=/enquiry", false);
        }

        StateHasChanged();
    }
    private async Task HandleItemSaleHistoryBackClick()
    {
        showItemSaleHistory = false;
        selectedProduct = null;
        StateHasChanged();
        await SetFocusOnSearchBoxAsync();
    }
    private async Task HandleBackClick(MouseEventArgs args)
    {
        _navigationManager.NavigateTo(BackButtonNavigationLink, false);
    }
    private async Task HandlePrintLabelClick(MouseEventArgs args)
    {
        if (selectedProduct != null)
        {
            // Print label for selected product
            await PrintSingleLabelAsync(selectedProduct);
        }
        else
        {
            // Show confirmation modal for printing all labels
            await ShowPrintAllLabelsConfirmationAsync();
        }
        await SetFocusOnSearchBoxAsync();
    }

    private async Task ShowPrintAllLabelsConfirmationAsync()
    {
        _state.ModalSettings = new ModalSettings
        {
            ModalTitle = "No Product Selected",
            ModalMessage = "No product was selected to print label. Would you like to print all enquired products label?",
            ShowModal = true,
            ModalEnum = ModalEnum.Confirmation
        };
        StateHasChanged();
    }

    private async Task PrintSingleLabelAsync(Product product)
    {
        try
        {
            List<Product> products = new List<Product> { product };
            _printerServices.PrintLabel(products);
        }
        catch (Exception ex)
        {
            await GlobalErrorLogService.LogErrorAsync(ex, nameof(PrintSingleLabelAsync), "Printing single label");
            await ShowErrorModalAsync("Print Error", $"Failed to print label: {ex.Message}");
        }
    }

    private async Task PrintAllLabelsAsync()
    {
        try
        {
            if (searchProducts?.Any() == true)
            {
                _printerServices.PrintLabel(searchProducts);
            }
            else
            {
                await ShowErrorModalAsync("Print Error", "No products available to print labels.");
            }
        }
        catch (Exception ex)
        {
            await GlobalErrorLogService.LogErrorAsync(ex, nameof(PrintAllLabelsAsync), "Printing all labels for enquiry results");
            await ShowErrorModalAsync("Print Error", $"Failed to print labels: {ex.Message}");
        }
    }
}
